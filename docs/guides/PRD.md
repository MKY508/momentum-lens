# Momentum Lens 产品需求文档（PRD）

## 1. 产品概述

**Momentum Lens** 是一个专门针对中国市场的智能ETF动量交易系统，采用Core-Satellite结构实现半自动化量化投资。

### 核心价值
- **一键决策**：自动计算市场环境、动量得分、相关性，生成交易指令
- **风险管理**：多层止损、缓冲区、最短持有期保护
- **简化操作**：周二执行、月末轮动的固定节奏

### 目标用户
- 量化投资爱好者
- 追求系统化交易的个人投资者
- 需要决策辅助的ETF投资者

---

## 2. 最小必需信息

| 分类 | 字段 | 说明 | 获取方式 |
|------|------|------|----------|
| **市场环境** | HS300日线收盘、MA200、ATR(20)、ATR20/价、近30日处于MA200±3%的天数 | 判年线闸/震荡层 | 数据拉取 + 本地计算 |
| **候选ETF** | 最近180根日线收盘 | 算60/120日涨幅与Score | 数据拉取 |
| **相关性** | 候选ETF近90日对数日收益 | 算ρ与第一腿≤0.8 | 数据拉取 + 本地计算 |
| **交易约束** | IOPV、折溢价（仅513500必要） | QDII买入阈值 | 数据拉取 |
| **你的持仓** | 代码、建仓价、建仓日、当前权重 | 判最短持有、缓冲比较、止损 | **用户手动录入一次**（之后系统维护） |
| **参数档位** | 止损、缓冲、最短持有、带宽、腿数上限 | 进攻/均衡/固定 | 用户在前端点选 |

⚠️ **重要**：持仓必须输入（至少4个字段），否则无法判断"是否达最短持有、是否满足缓冲换仓、止损位"。

---

## 3. 标的代码清单

### Core池（长期框架，目标60%）
- **宽基**：510300 或 159919（沪深300）
- **红利**：510880（上证红利）
- **现金/短融**：511990（货币ETF，作为现金停车位）
- **黄金**：518880（黄金ETF）
- **QDII**：513500（标普500 ETF，需看折溢价）

**执行规则**：
- Core总目标60%，DCA分6周进场
- 513500仅在溢价≤2%时买，不足则暂停在511990

### Satellite池（行业候选，去重后10-12只，目标40%）
- **成长线**（每期只选1支）：
  - 588000 科创50
  - 512760 半导体
  - 512720 计算机
  - 516010 或 159869（动漫游戏，二选一）
- **电新链**（三选一）：
  - 516160 新能源
  - 515790 光伏
  - 515030 新能源车
- **顺周期**：512400 有色金属
- **金融**：512800 银行、512000 证券
- **防御**：512170 医疗

**去重规则**：同主题只留1支主ETF（按AUM、成交额、跟踪误差择优）；"成长"与"电新链"各保留1条，避免相关性堆叠。

---

## 4. 界面设计

### A. 决策台（Home）

**目的**：一眼看出今天能否两条腿、买哪两只、下单区间

#### 环境条 Chips（只看）
- **Yearline**：在年线上/在年线下（显示收盘 vs MA200%）
- **波动**：ATR20/价 X.X%（>3.5%橙色）
- **CHOP**：ON/OFF（显示触发的2条条件）

#### 参数条 Presets（可切换）
- 进攻/均衡/固定（映射：止损、缓冲、最短持有、带宽）

#### 一键决策卡（系统产出、用户确认）
- **第一腿/第二腿**：代码、名称
- **建议权重**：5%（试仓）/10%（满）
- **限价带**：IOPV×[0.999, 1.001]（10:30/14:00）
- **资格灯**：缓冲✓ / 最短持有✓ / ρ≤0.8✓ / 腿数限制✓
- **QDII状态**：513500溢价≤2%可买 / ≥3%暂停

#### 动作按钮
- 复制下单指令（文本）
- 导出当日执行单（CSV/PDF）

### B. Core模块

#### 核心持仓表（可编辑）
| 列 | 说明 |
|----|------|
| 代码 | ETF代码 |
| 名称 | ETF名称 |
| 目标权重 | 预设目标% |
| 当前权重 | 实际持仓% |
| 偏离 | 偏离度 |
| 溢折价 | 仅513500显示 |
| 建议调整 | 系统计算 |

#### HS300日线图（只看）
- 叠加MA200，展示ATR20/价

#### 再平衡仪表（系统算）
- 偏离超±5pp高亮
- "一键回到目标±2pp"（生成指令，不直接交易）

### C. Satellite模块

#### 动量榜表（只看 + 可筛选）
| 列 | 说明 |
|----|------|
| 代码 | ETF代码 |
| 名称 | ETF名称 |
| 60D涨幅 | 60日涨幅% |
| 120D涨幅 | 120日涨幅% |
| Score | 动量得分 |
| 成交额 | 日成交额 |
| 点差 | 买卖价差 |

#### 筛选器
- 风格去重（成长只留1、电新只留1）

#### 相关性热图（系统算）
- 以Top1为锚，标红ρ>0.8的第二腿候选

#### 资格条（系统算）
- 每行显示：缓冲/最短持有/ρ/腿数 四个灯
- 全部绿才可替换

#### 换仓按钮
- 仅在月末亮起
- 或触发止损/破200日线时允许

### D. 日志/KPI

#### 交易日志
| 列 | 说明 |
|----|------|
| 日期 | 交易日期 |
| 动作 | 买入/卖出/调仓 |
| 代码 | ETF代码 |
| 金额 | 交易金额 |
| 成交价 | 执行价格 |
| 费用 | 手续费 |
| IS | 执行偏差 |
| 仓位结构 | 执行后仓位 |

#### KPI指标
- 月度IS
- 单位换手收益
- 最大回撤
- Calmar比率

#### 自动规则
- 连续两月"单位换手收益<0" → 次月卫星降10pp

### E. 参数设置页（可设置）

#### 档位选择
| 参数 | 进攻模式 | 均衡模式（默认） | 固定模式 |
|------|----------|-----------------|----------|
| 止损 | -10% | -12% | -15% |
| 缓冲 | 2% | 3% | 4% |
| 最短持有 | 2周 | 2周 | 4周 |
| 带宽 | ±5pp | ±7pp | ±7pp |
| 腿数上限 | 2 | 2 | 1 |

#### 自定义参数
- 相关性阈值：ρ≤0.8（可改）

---

## 5. 一键决策流程（系统后台8步）

1. **拉数据**：HS300、候选ETF、513500溢价、用户持仓
2. **算指标**：MA200、ATR20/价、r60/r120、Score、ρ
3. **判环境**：Yearline与CHOP（三选二）
4. **确定参数**：腿数上限、止损档、缓冲档、最短持有、带宽
5. **生成候选**：去重后按Score排序；以Top1为锚做ρ筛选出第二腿
6. **检查资格**：
   - 对"在持→候选"的分差是否≥缓冲
   - 是否达最短持有
   - 是否年线限制
7. **产出指令**：
   - **卫星**：每腿5%（试仓）或10%（满），IOPV±0.1%限价，时间窗10:30/14:00
   - **Core**：本周DCA金额拆分；513500仅当溢价≤2%
8. **写日志与预警**：记录Score/ρ/动作；触发年线解锁/回落、CHOP开/关、止损等

---

## 6. 用户需要看的 vs 系统自动的

| 模块 | 用户要看 | 系统自动 |
|------|----------|----------|
| 环境 | Yearline徽章、ATR20/价、CHOP状态 | 计算MA200、ATR、带内天数、判CHOP |
| 动量 | 动量榜Top1/2、资格灯 | 算r60/r120、Score、ρ、缓冲与持有期校验 |
| Core | 偏离与DCA金额 | 计算再平衡建议 |
| QDII | 513500溢价是否≤2% | 拉IOPV/折溢价、给提示 |
| 风控 | 止损触发、破200日线 | 监控并弹窗 |
| 决策 | 最终两条腿与限价带 | 一键生成指令卡 |

---

## 7. 用户必须手动输入的一次性信息

1. **初始持仓**：代码、建仓价、建仓日、当前权重
2. **账户总资产**（用于金额换算）
3. **参数档位默认选择**（建议"均衡"）
4. **候选池选择**（游戏二选一、电新链二选一，其余按上表勾选）

---

## 8. 每周/每日节奏（最小动作）

### 周日
打开决策台 → 看三条徽章 → 点"一键决策（预演）" → 保存周二指令

### 周二 10:30/14:00
按指令卡下单（复制限价带即可）；系统记IS

### 周内
只响应预警（止损/破200日线/年线回落）

### 月末
进入Sat → 看资格灯全绿才点"换仓"

---

## 9. 默认阈值（内置配置）

| 参数 | 默认值 | 说明 |
|------|--------|------|
| **腿数** | 年线上方2；年线下方1 | 根据市场环境调整 |
| **缓冲** | 默认3%；强趋势2%；震荡4% | 换仓缓冲区 |
| **最短持有** | 默认2周；震荡4周 | 最短持有期限 |
| **止损** | 默认-12%；强趋势-10%；震荡-15% | 止损线 |
| **相关性** | ρ≤0.8 | 第二腿相关性上限 |
| **执行窗** | 10:30/14:00；IOPV偏离≤0.1% | 交易时间窗口 |
| **QDII** | 溢价≤2%才买；≥3%暂停 | 513500特殊规则 |

---

## 10. 输出样例（指令卡）

```
═══════════════════════════════════════════════════
📊 Momentum Lens 交易指令卡
生成时间：2024-08-24 周日 20:00
═══════════════════════════════════════════════════

【市场环境】
✅ 年线状态：上方 +2.3%
⚠️ 波动率：ATR20/价 = 3.8%（偏高）
❌ CHOP：OFF（趋势市）
参数档位：均衡模式

【卫星配置】（40%）
第一腿：512400 有色金属 5%
  限价：IOPV×[0.999~1.001]
  时间：周二 10:30
  
第二腿：588000 科创50 5%
  限价：IOPV×[0.999~1.001]
  时间：周二 14:00
  相关性：ρ=0.55 ✅

【Core DCA】（本周第3/6周）
• 510300 沪深300：¥6,700
• 510880 上证红利：¥3,300
• 511990 货币ETF：¥5,000
• 518880 黄金ETF：¥3,300
• 513500 标普500：¥1,700（当前溢价1.8% ✅可买）

【风控设置】
• 卫星止损：-12%（均衡模式）
• 破200日线：减半持仓
• 最短持有：2周

【资格检查】
✅ 缓冲区：满足3%要求
✅ 持有期：已满2周
✅ 相关性：ρ=0.55≤0.8
✅ 腿数限制：2条（趋势市）

【执行提醒】
⏰ 周二 10:30 - 执行第一腿
⏰ 周二 14:00 - 执行第二腿
📝 记录IS（执行偏差）

═══════════════════════════════════════════════════
```

---

## 11. 核心公式

### 动量得分
```
Score = 0.6 × r60 + 0.4 × r120
其中：
- r60 = 60日涨幅
- r120 = 120日涨幅
```

### 相关性计算
```
ρ = corr(log(P1_t/P1_t-1), log(P2_t/P2_t-1))
计算窗口：90个交易日
```

### CHOP判断（3选2）
1. 近30日在MA200±3%带内天数≥10
2. ATR20/价≥3.5%且MA200的5日斜率在±0.5%
3. 双窗分散度小：Top1-Top3<3%且Top1-Top5<8%

### 年线解锁
- HS300连续5日收盘在MA200上，且最后一日≥+1%

### 年线回落
- 补完第二腿后3日内，收盘≤-1%重新跌回MA200

---

## 12. 调整触发条件

系统只在以下信号出现时调整参数或动作：

1. **进入CHOP** → 缓冲4%、最短4周、止损-15%、腿数1
2. **解锁后3日内年线回落** → 第二腿清零，回到1条腿
3. **单腿跌破自身200日线** → 该腿减半（继续观察）
4. **月末单位换手收益<0** → 次月卫星降10pp（如40%→30%）
5. **两腿相关性ρ>0.8** → 第二腿换成风格更"远"的候选
6. **513500溢价≥3%** → 暂停；≤2%才恢复

---

## 13. 系统自检清单（周日执行）

- [ ] HS300：收盘vs MA200（在上/在下）、ATR20/价、30日带内天数
- [ ] Sat候选：60/120日涨幅与Score=0.6×r60+0.4×r120排名
- [ ] 若允许两腿：Top2相对Top1的ρ≤0.8
- [ ] 本周参数：缓冲3%、最短持有2周、带宽±5pp
- [ ] Core DCA：按6周计划买入1/6，513500溢价阈值已设

---

## 14. 技术实现要点

### 数据源
- **主数据源**：AKShare（免费）
- **备用数据源**：新浪财经、东方财富
- **实时数据**：WebSocket推送（可选）

### 前端技术栈
- React 18 + TypeScript
- Material-UI组件库
- Recharts/Lightweight-charts图表
- React Query数据管理

### 后端技术栈
- Python FastAPI
- pandas数据处理
- SQLite数据库（简化版）
- Redis缓存（可选）

### 部署方案
- Docker容器化
- 前后端分离
- Nginx反向代理

---

## 15. 开发优先级

### P0 - 核心功能（必须）
1. 市场环境判断（年线、CHOP）
2. 动量得分计算
3. 相关性筛选
4. 一键生成指令卡

### P1 - 重要功能（应该）
1. 持仓管理与跟踪
2. 风险预警（止损、破线）
3. 交易日志记录
4. Core再平衡计算

### P2 - 增强功能（可以）
1. 实时价格推送
2. 自动执行接口
3. 回测功能
4. 多账户管理

---

## 附录：数据接口示例

### 获取ETF日线数据
```python
import akshare as ak

# 获取ETF历史数据
etf_hist_df = ak.fund_etf_hist_sina(
    symbol="510300",
    period="daily",
    adjust="qfq"
)
```

### 计算技术指标
```python
import pandas as pd
import numpy as np

def calculate_indicators(df):
    # MA200
    df['MA200'] = df['close'].rolling(200).mean()
    
    # ATR20
    df['TR'] = np.maximum(
        df['high'] - df['low'],
        np.abs(df['high'] - df['close'].shift()),
        np.abs(df['low'] - df['close'].shift())
    )
    df['ATR20'] = df['TR'].rolling(20).mean()
    
    # 动量
    df['r60'] = df['close'].pct_change(60)
    df['r120'] = df['close'].pct_change(120)
    df['score'] = 0.6 * df['r60'] + 0.4 * df['r120']
    
    return df
```

### 相关性计算
```python
def calculate_correlation(etf1_returns, etf2_returns, window=90):
    """计算两个ETF的相关性"""
    return etf1_returns.rolling(window).corr(etf2_returns)
```

---

**文档版本**：v1.0  
**最后更新**：2024-08-24  
**作者**：Momentum Lens Team