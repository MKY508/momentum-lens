# 策略回测功能说明

## 概述

Momentum Lens现已集成三种策略回测功能，让您可以测试不同的动量轮动策略：

1. **核心+慢腿轮动（月度）** - 基于3M-1M和6M-1M动量，月末调仓，含完整风控
2. **核心+快腿轮动（周度）** - 基于20日动量，每周五调仓，使用20日最低价止损
3. **核心+宏观驱动（12M-1M长波）** - 基于12个月动量剔除最近1个月，月末调仓

## 使用方法

### 交互式菜单

```bash
./momentum_lens.sh
```

然后按以下步骤操作：

1. 选择 `3. 回测与动量工具`
2. 选择 `5. 运行策略回测（慢腿/快腿/宏观驱动）`
3. 选择要测试的策略（1-3）
4. 选择券池预设（如core、satellite等）
5. 输入回测时间范围
6. 查看回测结果

### 策略详情

#### 策略1：核心+慢腿轮动（月度）

**调仓规则：**
- 每月最后一个交易日调仓
- 使用3M-1M (63日-21日) 和 6M-1M (126日-21日) 动量
- 动量权重：60% / 40%

**市场择时：**
- 沪深300在MA200上方：持有2条腿，每腿20%仓位
- 沪深300在MA200下方：持有1条腿，15%仓位

**风控规则：**
- 强趋势（MA200上方且ATR<4%）：止损-10%
- 基线（MA200上方）：止损-12%
- 震荡/高波动（MA200下方）：止损-15%

#### 策略2：核心+快腿轮动（周度）

**调仓规则：**
- 每周五调仓
- 使用20日收益率作为动量信号
- 市场择时规则同策略1

**风控规则：**
- 跌破20日最低价即止损

#### 策略3：核心+宏观驱动（12M-1M长波）

**调仓规则：**
- 每月最后一个交易日调仓
- 使用12个月动量剔除最近1个月（252日-21日）
- 市场择时规则同策略1

**风控规则：**
- 风控规则同策略1

## 回测结果指标

每次回测完成后会显示以下指标：

- **总收益率** - 整个回测期间的总收益
- **年化收益率** - 折算成年化的收益率
- **夏普比率** - 收益风险比，越高越好
- **最大回撤** - 最大亏损幅度
- **交易次数** - 总共执行的交易次数
- **最近5笔交易** - 显示最后5笔交易的详情

## 技术架构

### 文件结构

```
momentum-lens-github/
├── momentum_cli/
│   ├── backtest.py          # 回测引擎模块（新增）
│   ├── cli.py               # CLI主程序（已更新）
│   ├── analysis_presets.py  # 分析预设配置
│   └── data_loader.py       # 数据加载模块
└── BACKTEST_README.md      # 本文档
```

### 核心组件

1. **BacktestEngine** - 回测引擎基类
   - 数据加载
   - 交易执行
   - 收益计算
   - 指标统计

2. **策略函数**
   - `run_slow_leg_strategy()` - 慢腿策略
   - `run_fast_leg_strategy()` - 快腿策略
   - `run_macro_driven_strategy()` - 宏观驱动策略

3. **数据结构**
   - `BacktestConfig` - 回测配置
   - `Position` - 持仓信息
   - `Trade` - 交易记录
   - `BacktestResult` - 回测结果

## 注意事项

1. **数据要求**：需要先更新RQAlpha数据包
   ```bash
   ./momentum_lens.sh
   # 选择: 6. 更新数据（rqalpha bundle）
   ```

2. **时间范围**：建议至少1年以上的回测期间，以获得更有意义的结果

3. **参数复刻**：回测使用的动量参数自动从对应的分析预设中获取，保证与分析结果的一致性

4. **交易成本**：
   - 手续费：万三（0.03%）
   - 滑点：千一（0.1%）

## 未来改进

- [ ] 添加更多策略变体
- [ ] 支持自定义参数调优
- [ ] 生成详细的回测报告（PDF/HTML）
- [ ] 添加对比分析功能
- [ ] 支持保存回测结果

## 问题反馈

如遇到问题请检查：

1. RQAlpha数据包是否最新
2. 券池中的ETF是否都有数据
3. 时间范围是否合理

---

**版本**：1.0.0
**更新日期**：2025-10-06
