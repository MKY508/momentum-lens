# Momentum Lens 渐进式重构路线图

## 🎯 重构目标

将7000+行的单文件逐步重构为模块化架构，每个阶段都保证：
- ✅ 功能完整性
- ✅ 向后兼容
- ✅ 可独立回退
- ✅ 渐进改进

## 📋 重构原则

1. **小步快跑** - 每次只改进一个小模块
2. **功能验证** - 每步完成后都验证功能
3. **可回退性** - 每个改动都可以独立回退
4. **向后兼容** - 保持所有现有接口不变
5. **渐进优化** - 逐步提升代码质量

## 🗺️ 分阶段计划

### 第一阶段：提取工具函数 (预计收益: 减少200-300行)
**目标**: 将通用工具函数提取到独立模块
**范围**:
- 颜色处理函数 (`colorize`, `_set_color_enabled` 等)
- 字符串处理函数 (`_strip_ansi`, `_display_width` 等)
- 文件操作工具函数
- 数学计算工具函数

**实施方式**:
```python
# 创建 momentum_cli/utils/
├── __init__.py
├── colors.py      # 颜色处理
├── strings.py     # 字符串工具
├── files.py       # 文件操作
└── math.py        # 数学工具
```

**验证标准**:
- [ ] 所有原有功能正常
- [ ] 导入路径正确
- [ ] 性能无明显下降

### 第二阶段：提取UI组件 (预计收益: 减少800-1000行)
**目标**: 将用户界面相关函数模块化
**范围**:
- 菜单渲染函数 (`_render_menu_block`, `_prompt_menu_choice` 等)
- 用户输入处理 (`_read_keypress`, `_supports_interactive_menu` 等)
- 交互逻辑函数

**实施方式**:
```python
# 创建 momentum_cli/ui/
├── __init__.py
├── menu.py        # 菜单系统
├── input.py       # 用户输入
├── display.py     # 显示格式化
└── interactive.py # 交互逻辑
```

### 第三阶段：提取配置管理 (预计收益: 减少300-400行)
**目标**: 统一配置管理接口
**范围**:
- 设置相关函数
- 模板管理函数
- 预设管理函数

**实施方式**:
```python
# 扩展 momentum_cli/config/
├── settings.py    # 已存在，优化
├── templates.py   # 模板管理
└── presets.py     # 预设管理
```

### 第四阶段：提取业务逻辑 (预计收益: 减少1500-2000行)
**目标**: 将核心业务逻辑模块化
**范围**:
- 分析逻辑函数
- 回测逻辑函数
- 报告生成函数

**实施方式**:
```python
# 创建 momentum_cli/business/
├── __init__.py
├── analysis.py    # 分析逻辑
├── backtest.py    # 回测逻辑
└── reports.py     # 报告生成
```

### 第五阶段：重构主入口 (预计收益: 减少2000-3000行)
**目标**: 简化主入口文件
**范围**:
- 重新组织主函数
- 使用提取的模块
- 保持接口兼容

**最终目标**:
```
cli.py: 7000+ 行 → 500-800 行 (减少85%+)
```

## 🔄 每阶段的标准流程

### 1. 准备阶段
- [ ] 创建git分支
- [ ] 备份当前状态
- [ ] 运行完整测试

### 2. 实施阶段
- [ ] 创建新模块文件
- [ ] 复制相关函数
- [ ] 更新导入语句
- [ ] 保持原函数作为兼容层

### 3. 验证阶段
- [ ] 运行所有功能测试
- [ ] 检查性能影响
- [ ] 验证用户体验

### 4. 清理阶段
- [ ] 移除重复代码
- [ ] 更新文档
- [ ] 提交改动

### 5. 回退准备
- [ ] 记录回退步骤
- [ ] 保留回退脚本

## 📊 预期收益

| 阶段 | 减少行数 | 累计减少 | 主要收益 |
|------|----------|----------|----------|
| 第一阶段 | 200-300行 | 4% | 工具函数复用 |
| 第二阶段 | 800-1000行 | 18% | UI逻辑清晰 |
| 第三阶段 | 300-400行 | 24% | 配置统一管理 |
| 第四阶段 | 1500-2000行 | 52% | 业务逻辑模块化 |
| 第五阶段 | 2000-3000行 | 85%+ | 架构现代化 |

## 🛡️ 风险控制

1. **每阶段独立**: 可以在任何阶段停止或回退
2. **功能测试**: 每步都有完整的功能验证
3. **性能监控**: 确保重构不影响性能
4. **用户体验**: 保持用户界面和操作习惯不变

## 🚀 开始第一阶段

准备好开始第一阶段的重构了吗？我们将从最安全的工具函数提取开始。
